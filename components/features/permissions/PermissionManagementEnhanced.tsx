'use client';

import React, { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Input } from '@/components/ui/input';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Checkbox } from '@/components/ui/checkbox';
import { Textarea } from '@/components/ui/textarea';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { 
  Shield, Users, Plus, Search, Edit, Trash2, Eye, UserCog, 
  CheckCircle, XCircle, AlertTriangle, Settings
} from 'lucide-react';
import { 
  permissionService, 
  PermissionGroup, 
  OrganizationPermission,
  UserEffectivePermissionsResponse 
} from '@/lib/services/permission';\nimport { usePermissions } from '@/lib/hooks/usePermissions';\nimport { useAuth } from '@/components/providers/AuthContext';\n\ninterface UserPermissionData {\n  userId: string;\n  userName: string;\n  email: string;\n  role: string;\n  groups: PermissionGroup[];\n  effectivePermissions: string[];\n  customPermissions: string[];\n}\n\ninterface PermissionManagementProps {\n  userId?: string;\n  showUserSelection?: boolean;\n  onPermissionsChanged?: () => void;\n}\n\nexport function PermissionManagement({ \n  userId, \n  showUserSelection = true, \n  onPermissionsChanged \n}: PermissionManagementProps) {\n  const { user } = useAuth();\n  const { canManagePermissions } = usePermissions();\n  \n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [searchTerm, setSearchTerm] = useState('');\n  \n  // Data states\n  const [organizationPermissions, setOrganizationPermissions] = useState<OrganizationPermission[]>([]);\n  const [permissionGroups, setPermissionGroups] = useState<PermissionGroup[]>([]);\n  const [selectedUser, setSelectedUser] = useState<string>(userId || '');\n  const [userPermissionData, setUserPermissionData] = useState<UserPermissionData | null>(null);\n  const [availableUsers, setAvailableUsers] = useState<Array<{ id: string; name: string; email: string; role: string }>>([]);\n  \n  // Modal states\n  const [showCreateGroup, setShowCreateGroup] = useState(false);\n  const [showAssignPermissions, setShowAssignPermissions] = useState(false);\n  const [showUserPermissions, setShowUserPermissions] = useState(false);\n  \n  // Form states\n  const [newGroup, setNewGroup] = useState({ \n    name: '', \n    description: '', \n    permissions: [] as number[] \n  });\n  const [assignmentData, setAssignmentData] = useState({ \n    groupIds: [] as number[], \n    customPermissions: [] as number[] \n  });\n\n  useEffect(() => {\n    loadInitialData();\n  }, []);\n\n  useEffect(() => {\n    if (selectedUser) {\n      loadUserPermissions(selectedUser);\n    }\n  }, [selectedUser]);\n\n  const loadInitialData = async () => {\n    setLoading(true);\n    try {\n      await Promise.all([\n        loadOrganizationPermissions(),\n        loadPermissionGroups(),\n        loadAvailableUsers()\n      ]);\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'Failed to load data');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const loadOrganizationPermissions = async () => {\n    try {\n      const permissions = await permissionService.getOrganizationPermissions();\n      setOrganizationPermissions(permissions);\n    } catch (err) {\n      console.error('Failed to load organization permissions:', err);\n    }\n  };\n\n  const loadPermissionGroups = async () => {\n    try {\n      const groups = await permissionService.getPermissionGroups();\n      setPermissionGroups(groups);\n    } catch (err) {\n      console.error('Failed to load permission groups:', err);\n    }\n  };\n\n  const loadAvailableUsers = async () => {\n    // Mock users for now - in real implementation, this would fetch from user service\n    const mockUsers = [\n      { id: 'user1', name: 'Dr. John Smith', email: 'john.smith@hospital.com', role: 'DOCTOR' },\n      { id: 'user2', name: 'Nurse Jane Doe', email: 'jane.doe@hospital.com', role: 'NURSE' },\n      { id: 'user3', name: 'Admin User', email: 'admin@hospital.com', role: 'ADMIN' },\n    ];\n    setAvailableUsers(mockUsers);\n  };\n\n  const loadUserPermissions = async (userId: string) => {\n    try {\n      setLoading(true);\n      const response = await permissionService.getUserEffectivePermissions(userId);\n      const userData = availableUsers.find(u => u.id === userId);\n      \n      if (userData) {\n        setUserPermissionData({\n          userId: response.userId,\n          userName: userData.name,\n          email: userData.email,\n          role: userData.role,\n          groups: response.groups,\n          effectivePermissions: response.effectivePermissions,\n          customPermissions: response.customPermissions\n        });\n      }\n    } catch (err) {\n      console.error('Failed to load user permissions:', err);\n      setError(err instanceof Error ? err.message : 'Failed to load user permissions');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const createPermissionGroup = async () => {\n    try {\n      await permissionService.createPermissionGroup({\n        groupName: newGroup.name,\n        description: newGroup.description,\n        organizationPermissionIds: newGroup.permissions\n      });\n      \n      await loadPermissionGroups();\n      setShowCreateGroup(false);\n      setNewGroup({ name: '', description: '', permissions: [] });\n      onPermissionsChanged?.();\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'Failed to create permission group');\n    }\n  };\n\n  const assignPermissionsToUser = async () => {\n    if (!selectedUser) return;\n    \n    try {\n      // Assign groups\n      if (assignmentData.groupIds.length > 0) {\n        await permissionService.assignGroupsToUser(selectedUser, {\n          groupIds: assignmentData.groupIds\n        });\n      }\n      \n      // Assign custom permissions\n      if (assignmentData.customPermissions.length > 0) {\n        await permissionService.assignCustomPermissions(selectedUser, {\n          permissions: assignmentData.customPermissions.map(id => ({ \n            permissionId: id, \n            isGranted: true \n          }))\n        });\n      }\n      \n      await loadUserPermissions(selectedUser);\n      setShowAssignPermissions(false);\n      setAssignmentData({ groupIds: [], customPermissions: [] });\n      onPermissionsChanged?.();\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'Failed to assign permissions');\n    }\n  };\n\n  const removeGroupFromUser = async (groupId: number) => {\n    if (!selectedUser) return;\n    \n    try {\n      await permissionService.removeGroupFromUser(selectedUser, groupId);\n      await loadUserPermissions(selectedUser);\n      onPermissionsChanged?.();\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'Failed to remove group');\n    }\n  };\n\n  const deletePermissionGroup = async (groupId: number) => {\n    try {\n      await permissionService.deletePermissionGroup(groupId);\n      await loadPermissionGroups();\n      onPermissionsChanged?.();\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'Failed to delete permission group');\n    }\n  };\n\n  const filteredPermissions = organizationPermissions.filter(p => \n    p.isEnabled && (\n      p.permissionName.toLowerCase().includes(searchTerm.toLowerCase()) ||\n      p.permissionCode.toLowerCase().includes(searchTerm.toLowerCase())\n    )\n  );\n\n  const filteredGroups = permissionGroups.filter(g => \n    g.groupName.toLowerCase().includes(searchTerm.toLowerCase())\n  );\n\n  const groupedPermissions = filteredPermissions.reduce((acc, perm) => {\n    const category = perm.permissionCode.split('_')[0] || 'GENERAL';\n    if (!acc[category]) acc[category] = [];\n    acc[category].push(perm);\n    return acc;\n  }, {} as Record<string, OrganizationPermission[]>);\n\n  if (!canManagePermissions()) {\n    return (\n      <Alert>\n        <AlertTriangle className=\"h-4 w-4\" />\n        <AlertDescription>\n          You don't have permission to manage permissions.\n        </AlertDescription>\n      </Alert>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {error && (\n        <Alert variant=\"destructive\">\n          <AlertTriangle className=\"h-4 w-4\" />\n          <AlertDescription>{error}</AlertDescription>\n        </Alert>\n      )}\n\n      {/* User Selection */}\n      {showUserSelection && (\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <UserCog className=\"h-5 w-5\" />\n              Select User\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <Select value={selectedUser} onValueChange={setSelectedUser}>\n              <SelectTrigger>\n                <SelectValue placeholder=\"Select a user to manage permissions\" />\n              </SelectTrigger>\n              <SelectContent>\n                {availableUsers.map((user) => (\n                  <SelectItem key={user.id} value={user.id}>\n                    {user.name} ({user.email}) - {user.role}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* User Permissions Overview */}\n      {userPermissionData && (\n        <Card>\n          <CardHeader>\n            <div className=\"flex items-center justify-between\">\n              <CardTitle className=\"flex items-center gap-2\">\n                <Shield className=\"h-5 w-5\" />\n                User Permissions: {userPermissionData.userName}\n              </CardTitle>\n              <div className=\"flex gap-2\">\n                <Button \n                  variant=\"outline\" \n                  size=\"sm\"\n                  onClick={() => setShowAssignPermissions(true)}\n                >\n                  <Plus className=\"h-4 w-4 mr-2\" />\n                  Assign Permissions\n                </Button>\n                <Button \n                  variant=\"outline\" \n                  size=\"sm\"\n                  onClick={() => setShowUserPermissions(true)}\n                >\n                  <Eye className=\"h-4 w-4 mr-2\" />\n                  View All Permissions\n                </Button>\n              </div>\n            </div>\n          </CardHeader>\n          <CardContent>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n              <div>\n                <h4 className=\"font-medium mb-3\">Permission Groups</h4>\n                <div className=\"space-y-2\">\n                  {userPermissionData.groups.map((group) => (\n                    <div key={group.id} className=\"flex items-center justify-between p-3 border rounded-lg\">\n                      <div>\n                        <p className=\"font-medium\">{group.groupName}</p>\n                        <p className=\"text-sm text-muted-foreground\">\n                          {group.permissions.length} permissions\n                        </p>\n                      </div>\n                      <Button \n                        variant=\"ghost\" \n                        size=\"sm\"\n                        onClick={() => removeGroupFromUser(group.id)}\n                      >\n                        <Trash2 className=\"h-4 w-4\" />\n                      </Button>\n                    </div>\n                  ))}\n                  {userPermissionData.groups.length === 0 && (\n                    <p className=\"text-muted-foreground text-sm\">No groups assigned</p>\n                  )}\n                </div>\n              </div>\n              \n              <div>\n                <h4 className=\"font-medium mb-3\">Permission Summary</h4>\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center justify-between p-3 border rounded-lg\">\n                    <span>Total Effective Permissions</span>\n                    <Badge variant=\"secondary\">\n                      {userPermissionData.effectivePermissions.length}\n                    </Badge>\n                  </div>\n                  <div className=\"flex items-center justify-between p-3 border rounded-lg\">\n                    <span>Custom Permissions</span>\n                    <Badge variant=\"outline\">\n                      {userPermissionData.customPermissions.length}\n                    </Badge>\n                  </div>\n                  <div className=\"flex items-center justify-between p-3 border rounded-lg\">\n                    <span>Permission Groups</span>\n                    <Badge variant=\"outline\">\n                      {userPermissionData.groups.length}\n                    </Badge>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Permission Groups Management */}\n      <Card>\n        <CardHeader>\n          <div className=\"flex items-center justify-between\">\n            <CardTitle className=\"flex items-center gap-2\">\n              <Users className=\"h-5 w-5\" />\n              Permission Groups\n            </CardTitle>\n            <Button onClick={() => setShowCreateGroup(true)}>\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Create Group\n            </Button>\n          </div>\n        </CardHeader>\n        <CardContent>\n          <div className=\"space-y-4\">\n            <div className=\"relative\">\n              <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n              <Input\n                placeholder=\"Search groups...\"\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                className=\"pl-10\"\n              />\n            </div>\n            \n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n              {filteredGroups.map((group) => (\n                <Card key={group.id} className=\"hover:shadow-md transition-shadow\">\n                  <CardHeader className=\"pb-3\">\n                    <div className=\"flex items-center justify-between\">\n                      <CardTitle className=\"text-base\">{group.groupName}</CardTitle>\n                      <div className=\"flex gap-1\">\n                        <Button variant=\"ghost\" size=\"sm\">\n                          <Edit className=\"h-4 w-4\" />\n                        </Button>\n                        <Button \n                          variant=\"ghost\" \n                          size=\"sm\"\n                          onClick={() => deletePermissionGroup(group.id)}\n                        >\n                          <Trash2 className=\"h-4 w-4\" />\n                        </Button>\n                      </div>\n                    </div>\n                  </CardHeader>\n                  <CardContent>\n                    <p className=\"text-sm text-muted-foreground mb-3\">\n                      {group.description || 'No description'}\n                    </p>\n                    <div className=\"flex items-center justify-between\">\n                      <Badge variant=\"outline\">\n                        {group.permissions.length} permissions\n                      </Badge>\n                      <span className=\"text-xs text-muted-foreground\">\n                        {group.userCount || 0} users\n                      </span>\n                    </div>\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Create Group Modal */}\n      <Dialog open={showCreateGroup} onOpenChange={setShowCreateGroup}>\n        <DialogContent className=\"max-w-2xl\">\n          <DialogHeader>\n            <DialogTitle>Create Permission Group</DialogTitle>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div>\n              <label className=\"text-sm font-medium\">Group Name</label>\n              <Input\n                value={newGroup.name}\n                onChange={(e) => setNewGroup({ ...newGroup, name: e.target.value })}\n                placeholder=\"Enter group name\"\n              />\n            </div>\n            <div>\n              <label className=\"text-sm font-medium\">Description</label>\n              <Textarea\n                value={newGroup.description}\n                onChange={(e) => setNewGroup({ ...newGroup, description: e.target.value })}\n                placeholder=\"Enter group description\"\n              />\n            </div>\n            <div>\n              <label className=\"text-sm font-medium\">Permissions</label>\n              <div className=\"grid grid-cols-1 gap-4 max-h-60 overflow-y-auto border rounded p-3\">\n                {Object.entries(groupedPermissions).map(([category, permissions]) => (\n                  <div key={category}>\n                    <h4 className=\"font-medium text-sm mb-2\">{category.replace('_', ' ')}</h4>\n                    <div className=\"grid grid-cols-1 gap-2 ml-4\">\n                      {permissions.map((permission) => (\n                        <div key={permission.id} className=\"flex items-center space-x-2\">\n                          <Checkbox\n                            id={`perm-${permission.id}`}\n                            checked={newGroup.permissions.includes(permission.id)}\n                            onCheckedChange={(checked) => {\n                              if (checked) {\n                                setNewGroup({\n                                  ...newGroup,\n                                  permissions: [...newGroup.permissions, permission.id]\n                                });\n                              } else {\n                                setNewGroup({\n                                  ...newGroup,\n                                  permissions: newGroup.permissions.filter(p => p !== permission.id)\n                                });\n                              }\n                            }}\n                          />\n                          <label htmlFor={`perm-${permission.id}`} className=\"text-sm\">\n                            {permission.permissionName}\n                          </label>\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n                ))}\n              </div>\n            </div>\n            <div className=\"flex justify-end gap-2\">\n              <Button variant=\"outline\" onClick={() => setShowCreateGroup(false)}>\n                Cancel\n              </Button>\n              <Button onClick={createPermissionGroup} disabled={!newGroup.name}>\n                Create Group\n              </Button>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      {/* Assign Permissions Modal */}\n      <Dialog open={showAssignPermissions} onOpenChange={setShowAssignPermissions}>\n        <DialogContent className=\"max-w-2xl\">\n          <DialogHeader>\n            <DialogTitle>Assign Permissions</DialogTitle>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div>\n              <label className=\"text-sm font-medium\">Permission Groups</label>\n              <div className=\"space-y-2 max-h-40 overflow-y-auto border rounded p-3\">\n                {permissionGroups.map((group) => (\n                  <div key={group.id} className=\"flex items-center space-x-2\">\n                    <Checkbox\n                      id={`assign-group-${group.id}`}\n                      checked={assignmentData.groupIds.includes(group.id)}\n                      onCheckedChange={(checked) => {\n                        if (checked) {\n                          setAssignmentData({\n                            ...assignmentData,\n                            groupIds: [...assignmentData.groupIds, group.id]\n                          });\n                        } else {\n                          setAssignmentData({\n                            ...assignmentData,\n                            groupIds: assignmentData.groupIds.filter(id => id !== group.id)\n                          });\n                        }\n                      }}\n                    />\n                    <label htmlFor={`assign-group-${group.id}`} className=\"text-sm\">\n                      {group.groupName} ({group.permissions.length} permissions)\n                    </label>\n                  </div>\n                ))}\n              </div>\n            </div>\n            <div className=\"flex justify-end gap-2\">\n              <Button variant=\"outline\" onClick={() => setShowAssignPermissions(false)}>\n                Cancel\n              </Button>\n              <Button onClick={assignPermissionsToUser}>\n                Assign Permissions\n              </Button>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      {/* View User Permissions Modal */}\n      <Dialog open={showUserPermissions} onOpenChange={setShowUserPermissions}>\n        <DialogContent className=\"max-w-4xl\">\n          <DialogHeader>\n            <DialogTitle>All User Permissions</DialogTitle>\n          </DialogHeader>\n          {userPermissionData && (\n            <div className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <h4 className=\"font-medium mb-2\">User Information</h4>\n                  <div className=\"space-y-1 text-sm\">\n                    <p><strong>Name:</strong> {userPermissionData.userName}</p>\n                    <p><strong>Email:</strong> {userPermissionData.email}</p>\n                    <p><strong>Role:</strong> {userPermissionData.role}</p>\n                  </div>\n                </div>\n                <div>\n                  <h4 className=\"font-medium mb-2\">Permission Summary</h4>\n                  <div className=\"space-y-1 text-sm\">\n                    <p><strong>Groups:</strong> {userPermissionData.groups.length}</p>\n                    <p><strong>Effective Permissions:</strong> {userPermissionData.effectivePermissions.length}</p>\n                    <p><strong>Custom Permissions:</strong> {userPermissionData.customPermissions.length}</p>\n                  </div>\n                </div>\n              </div>\n              \n              <div>\n                <h4 className=\"font-medium mb-2\">All Effective Permissions</h4>\n                <div className=\"max-h-60 overflow-y-auto border rounded p-3\">\n                  <div className=\"grid grid-cols-2 gap-2\">\n                    {userPermissionData.effectivePermissions.map((permission) => (\n                      <div key={permission} className=\"flex items-center gap-2 p-2 border rounded\">\n                        <CheckCircle className=\"h-4 w-4 text-green-500\" />\n                        <span className=\"text-sm\">{permission}</span>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              </div>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}